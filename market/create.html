<!DOCTYPE html>
<html lang="en" class="arca-page">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Create — RANNTA ARCA</title>
  <meta name="description" content="Create and mint NFTs on RANNTA ARCA." />
  <meta name="theme-color" content="#0f0f11" />
  <link rel="icon" href="assets/rannta-arca1.png" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="preload" as="script" href="assets/tonconnect-ui.min.js" />
  <link rel="stylesheet" href="assets/marketplace.css" />

  <!-- Minimal modal styles (scoped to this page) -->
  <style>
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .modal{
      width:min(560px, 92vw); background:#16161a; border:1px solid #2a2a31;
      border-radius:16px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      color:#e7e7ea;
    }
    .modal .title{font-size:18px; font-weight:700; margin:0 0 8px; color:#FBBF24;}
    .modal .row{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #2a2a31;}
    .modal .row:last-child{border-bottom:0;}
    .modal .k{color:#a1a1aa;}
    .modal .v{font-weight:700;}
    .modal .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:14px;}
    .modal .hint{font-size:12px; color:#a1a1aa;}
    .link{color:#FBBF24; text-decoration:none;}
    .toggle{cursor:pointer; user-select:none;}
    #advanced{display:none; margin-top:10px; padding:10px; border:1px solid #2a2a31; border-radius:12px; background:#121216;}
    .grid-form{display:grid; gap:12px; grid-template-columns:1fr;}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .field{display:flex; flex-direction:column; gap:6px;}
    .field label{font-size:12px; color:#a1a1aa;}
    .input, .textarea, .select{
      border:1px solid #2a2a31; background:#16161a; color:#cfcfd3; border-radius:10px; padding:10px 12px;
    }
    .textarea{min-height:100px; resize:vertical;}
    .btn-row{display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:12px;}
    .btn{background:#FBBF24; color:#111; font-weight:700; padding:10px 12px; border:none; border-radius:12px; cursor:pointer;}
    .btn.secondary{background:#232327; color:#e7e7ea; border:1px solid #2a2a31;}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid #2a2a31; font-size:12px; color:#cfcfd3;}
    .muted{color:#a1a1aa; font-size:12px;}
    @media (max-width: 720px){ .grid-2{grid-template-columns:1fr;} }
    .hidden{display:none !important;}
  </style>
</head>
<body data-page="create">
  <header class="header">
    <div class="wrap header-grid">
      <div class="left">
        <a class="brand" href="index.html">
          <img class="logo" src="assets/rannta-arca1.png" alt="RANNTA ARCA" />
          <span class="brand-text">RANNTA ARCA</span>
        </a>
        <nav class="nav">
          <a href="index.html">Explore</a>
          <a href="collection.html">Collections</a>
          <a href="create.html">Create</a>
          <a id="nav-profile" href="profile.html">Profile</a>
        </nav>
      </div>
      <div class="middle"></div>
      <div class="actions">
        <a id="btn-swap" class="pill" href="javascript:void(0)" role="button">↔ Swap</a>
        <a id="btn-connect" class="pill" href="javascript:void(0)" role="button">
          <span class="label">Connect Wallet</span>
        </a>
        <a id="btn-disconnect" class="pill hidden" href="javascript:void(0)" role="button">Disconnect</a>
      </div>
      <!-- TonConnect mount point (hidden) -->
      <div id="tonconnect" class="connect" aria-hidden="true"></div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Create Collection</h1>
      <p class="meta">Define your collection details, media, and mint plan. You’ll confirm costs before deploying.</p>
    </section>

    <!-- Basic form -->
    <form id="create-form" class="grid-form" novalidate>
      <div class="grid-2">
        <div class="field">
          <label for="name">Collection name *</label>
          <input id="name" class="input" type="text" placeholder="e.g. Rannta Genesis" required />
        </div>
        <div class="field">
          <label for="slug">Slug *</label>
          <input id="slug" class="input" type="text" placeholder="rannta-genesis" required />
        </div>
      </div>

      <div class="field">
        <label for="desc">Description</label>
        <textarea id="desc" class="textarea" placeholder="Up to 500–1000 characters."></textarea>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="supply">Total supply *</label>
          <input id="supply" class="input" type="number" min="1" step="1" placeholder="e.g. 1000" required />
        </div>
        <div class="field">
          <label for="price">Mint price (TON)</label>
          <input id="price" class="input" type="number" min="0" step="0.01" placeholder="e.g. 0.5" />
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="royalty">Creator royalty %</label>
          <input id="royalty" class="input" type="number" min="0" max="15" step="0.5" placeholder="e.g. 5" />
        </div>
        <div class="field">
          <label for="royaltyAddr">Royalty address (defaults to creator)</label>
          <input id="royaltyAddr" class="input" type="text" placeholder="UQ... (optional)" />
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="logo">Logo / Cover (1:1, ≤ 2MB)</label>
          <input id="logo" class="input" type="file" accept=".jpg,.jpeg,.png,.webp" />
        </div>
        <div class="field">
          <label for="banner">Banner (optional)</label>
          <input id="banner" class="input" type="file" accept=".jpg,.jpeg,.png,.webp" />
        </div>
      </div>

      <div class="field">
        <label for="links">Links (website, socials)</label>
        <input id="links" class="input" type="text" placeholder="https://..., https://twitter.com/..., ..." />
        <span class="muted">Separate by comma. Optional.</span>
      </div>

      <div class="btn-row">
        <span class="muted" id="wallet-hint">Connect wallet to continue.</span>
        <button type="button" id="btn-review" class="btn">Review & Create</button>
      </div>
    </form>
  </main>

  <footer class="footer">© 2025 RANNTA ARCA — All rights reserved.</footer>

  <!-- Confirm Modal -->
  <div class="modal-backdrop" id="confirm-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cost-title">
      <h2 class="title" id="cost-title">Confirm costs</h2>

      <div class="row">
        <div class="k">Network (Deploy)</div>
        <div class="v">~ 0.05–0.20 TON</div>
      </div>
      <div class="row">
        <div class="k">Network (Mint per NFT)</div>
        <div class="v">~ 0.05–0.10 TON <span class="pill">avg ~0.08 TON</span></div>
      </div>
      <div class="row">
        <div class="k">Off-chain storage</div>
        <div class="v">5GB free (Web3.Storage), more based on usage</div>
      </div>
      <div class="row">
        <div class="k">Marketplace fee</div>
        <div class="v">2–3% (suggested) + Creator royalty</div>
      </div>

      <div style="margin-top:10px;">
        <a href="#" id="toggle-adv" class="link toggle">Show advanced ▸</a>
        <div id="advanced">
          <p class="hint">
            TON fees depend on message size, code/storage usage, and network load. Learn more in the
            <a class="link" href="https://docs.ton.org/learn/overviews/fees" target="_blank" rel="noopener">TON fee model docs</a>.
          </p>
          <ul class="hint" style="margin:6px 0 0 18px; line-height:1.6;">
            <li>We store media/JSON off-chain (IPFS/Arweave). On-chain keeps only pointers & royalty config.</li>
            <li>Final cost may slightly vary at confirm time in wallet.</li>
          </ul>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label style="display:flex; gap:8px; align-items:center; font-size:13px;">
          <input type="checkbox" id="agree" />
          <span>I confirm the information is correct and I accept the fees.</span>
        </label>
      </div>

      <div class="actions">
        <button class="btn secondary" id="btn-cancel" type="button">Cancel</button>
        <button class="btn" id="btn-confirm" type="button" disabled>Confirm & Create</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="assets/tonconnect-ui.min.js"></script>
  <script src="assets/app.js"></script>
  <script>
    // Service worker (optional)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/market/service-worker.js', { scope: '/market/' })
          .catch(console.error);
      });
    }

    // ====== Page logic (review modal + simple validations) ======
    const els = {
      form: document.getElementById('create-form'),
      name: document.getElementById('name'),
      slug: document.getElementById('slug'),
      supply: document.getElementById('supply'),
      price: document.getElementById('price'),
      royalty: document.getElementById('royalty'),
      royaltyAddr: document.getElementById('royaltyAddr'),
      review: document.getElementById('btn-review'),
      walletHint: document.getElementById('wallet-hint'),
      // modal
      backdrop: document.getElementById('confirm-backdrop'),
      cancel: document.getElementById('btn-cancel'),
      confirm: document.getElementById('btn-confirm'),
      agree: document.getElementById('agree'),
      toggleAdv: document.getElementById('toggle-adv'),
      advanced: document.getElementById('advanced')
    };

    // Auto slug from name
    els.name.addEventListener('input', () => {
      if (!els.slug.dataset.touched) {
        els.slug.value = (els.name.value || '')
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 48);
      }
    });
    els.slug.addEventListener('input', () => els.slug.dataset.touched = '1');

    // Check wallet connection (from app.js we store 'rannta_wallet')
    function isWalletConnected(){
      return !!localStorage.getItem('rannta_wallet');
    }
    function syncWalletHint(){
      els.walletHint.textContent = isWalletConnected()
        ? 'Wallet connected. Review to confirm costs.'
        : 'Connect wallet to continue.';
    }
    syncWalletHint();
    window.addEventListener('storage', (e) => { if (e.key === 'rannta_wallet') syncWalletHint(); });

    // Basic client validation
    function validateForm(){
      if (!els.name.value.trim()) return false;
      if (!els.slug.value.trim() || !/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(els.slug.value)) return false;
      if (!els.supply.value || Number(els.supply.value) <= 0) return false;
      return true;
    }

    // Review & open modal
    els.review.addEventListener('click', () => {
      if (!isWalletConnected()){
        alert('Please connect your wallet first.');
        return;
      }
      if (!validateForm()){
        alert('Please fill required fields (valid slug, supply > 0).');
        return;
      }
      openModal();
    });

    // Modal controls
    function openModal(){
      els.backdrop.style.display = 'flex';
      els.confirm.disabled = !els.agree.checked;
    }
    function closeModal(){
      els.backdrop.style.display = 'none';
    }
    els.cancel.addEventListener('click', closeModal);
    els.backdrop.addEventListener('click', (e)=>{ if(e.target === els.backdrop) closeModal(); });
    els.agree.addEventListener('change', ()=> els.confirm.disabled = !els.agree.checked);

    // Show advanced toggle
    let advOpen = false;
    els.toggleAdv.addEventListener('click', (e)=>{
      e.preventDefault();
      advOpen = !advOpen;
      els.advanced.style.display = advOpen ? 'block' : 'none';
      els.toggleAdv.textContent = advOpen ? 'Hide advanced ▾' : 'Show advanced ▸';
    });

    // Confirm & Create (placeholder wiring)
    els.confirm.addEventListener('click', async ()=>{
      // Here you’d typically: upload media+metadata → get URIs → sign → sendTransaction (deploy)
      // For now, we just emit an event and close modal.
      const payload = {
        name: els.name.value.trim(),
        slug: els.slug.value.trim(),
        supply: Number(els.supply.value || 0),
        priceTon: Number(els.price.value || 0),
        royaltyPct: Number(els.royalty.value || 0),
        royaltyAddr: els.royaltyAddr.value.trim() || null
      };
      console.log('[CREATE:CONFIRMED]', payload);
      window.dispatchEvent(new CustomEvent('arca:create:confirm', { detail: payload }));
      closeModal();
      alert('Costs confirmed. Next step: deploy collection (sendTransaction).');
    });
  </script>
</body>
</html>
